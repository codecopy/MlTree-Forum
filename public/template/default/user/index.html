{extend name="default/public/main"}
{block name="menu"}
{include file='default/public/topbar' /}{// 默认的topbar直接使用这一段即可}
{/block}
{block name="main"}
<div class="mdui-card">
    <div class="mdui-card-media">
        <img style="min-height: 200px;" src="__IMG__bg.jpg" alt="背景" />
        <div class="mlt-user-info">
            <div class="mlt-avatar-box">
                <div class="mlt-avatar-upload">
                    <button id="avatar_new" title="上传新头像" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon material-icons">photo_camera</i></button>
                </div>
                <img src="{$memberData.avatar}" alt="{$memberData.username}的头像" id="avatar_preview" />
            </div>
            <div class="mlt-user-username">
                {$memberData.username}
            </div>
            <div class="mlt-user-data">
                <span>{eq name="type" value="Self"}<button class="mdui-btn mdui-btn-icon mdui-ripple" mdui-tooltip="{content:'Edit biography'}" id="edit-bio"><i class="mdui-icon material-icons">edit</i></button>{/eq}{$memberData.motto|default="这家伙很懒，什么也没留下"}</span>
            </div>
        </div>
    </div>
</div>
<div class="mainstream-division"></div>
<div class="mdui-card">
    <ul class="mdui-list">
        <!--Basic user information-->
        <li class="mdui-subheader">Basic Information</li>
        <li class="mdui-list-item mdui-ripple">
            <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-theme-accent">perm_identity</i>
            <div class="mdui-list-item-content">{$memberData.uid}</div>
        </li>
        <li class="mdui-list-item mdui-ripple">
            <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-theme-accent">group</i>
            <div class="mdui-list-item-content">{$memberData.groupData.groupName}</div>
        </li>
        <li class="mdui-list-item mdui-ripple">
            <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-theme-accent">access_time</i>
            <div class="mdui-list-item-content">{$memberData.login_date|time_format}</div>
        </li>
        <li class="mdui-list-item mdui-ripple">
            <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-theme-accent">email</i>
            <div class="mdui-list-item-content">{$memberData.uid}</div>
        </li>
        <li class="mdui-list-item mdui-ripple">
            <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-theme-accent">lock</i>
            <div class="mdui-list-item-content">为了该用户的安全，密码不予显示</div>
        </li>
    </ul>
</div>
{eq name="type" value="Self"}
<!--Modify user's password ~~and biography~~.-->
<!--And how is that possible to open to guests.-->
<div class="mainstream-division"></div>
<form id="update-password" class="mdui-card">
    <!--I don't know the best method to display the title.-->
    <div class="mdui-subheader">Update Password</div>
    <div class="mdui-card-content">
            <div class="mdui-textfield mdui-textfield-floating-label">
                    <i class="mdui-icon material-icons">lock</i>
                    <label class="mdui-textfield-label">Original Password</label>
                    <!--Sorry but I am unable to change the name of a field key.-->
                    <input name="oldpassword" class="mdui-textfield-input" type="password" required />
                    <div class="mdui-textfield-error">Original password is required</div>
            </div>
            <div class="mdui-textfield mdui-textfield-floating-label">
                    <i class="mdui-icon material-icons">lock</i>
                    <label class="mdui-textfield-label">Password</label>
                    <input name="password" class="mdui-textfield-input" type="password" required />
                    <div class="mdui-textfield-error">Password is required</div>
            </div>
            <div class="mdui-textfield mdui-textfield-floating-label">
                    <i class="mdui-icon material-icons">lock</i>
                    <label class="mdui-textfield-label">Confirm</label>
                    <input name="repassword" class="mdui-textfield-input" type="password" required />
                    <div class="mdui-textfield-error">Confirmed password is invalid</div>
            </div>
            {:token()}
    </div>
    <div class="mdui-card-actions">
        <button class="mdui-btn mdui-float-right mdui-color-theme-accent mdui-ripple">Update</button>
    </div>
</form>
{/eq}
<div class="mainstream-division"></div>
<div class="mdui-card">
    <ul class="mdui-list">
            {volist name="userTopic" id="vo"}
            <li class="mdui-list-item mdui-ripple">
                <div class="mdui-list-item-avatar">
                    <img src="{$vo.memberData.avatar}" alt="{$vo.memberData.username}" title="{$vo.memberData.username}">
                </div>
                <div class="mdui-list-item-content">
                    <a class="mdui-list-item-title" href="{:url('forum/topic/index',['tid'=>$vo.tid])}">{$vo.subject}</a>
                    <div class="mdui-list-item-text mdui-list-item-one-line">{$vo.content|raw}</div>
                    <div class="mdui-list-item-text">
                        <a class="mdui-list-item-title" href="{:url('forum/user/index',['uid'=>$vo.uid])}">{$vo.memberData.username}</a>
                        <span title="{$vo.create_time}"> · {$vo.time_format} · {$vo.comment}回复</span>
                    </div>
                </div>
            </li>
            <li class="mdui-divider-inset mdui-m-y-0"></li>
            {/volist}
    </ul>
</div>
{/block}

{block name="js"}
<script>
    //Rewrited biography updater by DFFZMXJ
    $$('#edit-bio').on('click',function(){
        mdui.prompt("New Biography",function(value){
            $$.ajax({
                method:"POST",
                url: '{:url("set")}',
                data: "motto="+escape(value),
                dataType:"json",
                success: response=>{
                    mdui.snackbar(response.msg);
                },
                error: xhr=> mdui.snackbar("Unknwon error has occurred.")
            });
        },function(){},{
            confirmOnEnter:true,
            confirmText:"Update",
            defaultValue:`{$memberData.motto|default=''}`//Defined in back-end, probably unsafe.
        });
    });
    $$('#update-password').on('submit', function () {
        var data = $$('#update-password').serialize();
        $$.ajax({
            method: 'post',
            url: '{:url("ResetPwd")}',
            data: data,
            dataType: 'json',
            success: function (res) {
                if (res.code == 0) {
                    mdui.snackbar({
                        message: res.msg,
                        position: 'top',
                        onClosed: function () {
                            window.location.href = res.url;
                        },
                    })
                } else {
                    mdui.snackbar({
                        message: res.msg,
                        position: 'top',
                    })
                }
            },
        });
        return false;
    });
</script>
{/block}